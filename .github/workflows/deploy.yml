name: Deploy ROQ site to GitHub Pages

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build ROQ site
        run: ./mvnw package quarkus:run
        env:
          QUARKUS_ROQ_GENERATOR_BATCH: true
          QUARKUS_HTTP_ROOT_PATH: /pejsam-website/

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/roq
          # Keep existing files (like preview directories) on gh-pages branch
          keep_files: true

  cleanup-closed-prs:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: Check if gh-pages branch exists
        id: check-branch
        run: |
          if git ls-remote --exit-code --heads \
            https://github.com/${{ github.repository }}.git gh-pages \
            > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ℹ️ gh-pages branch does not exist yet, skipping cleanup"
          fi

      - name: Checkout gh-pages branch
        if: steps.check-branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Cleanup closed PR preview folders
        if: steps.check-branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const exec = require('@actions/exec');

            const { data: openPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const openPRNumbers = new Set(openPRs.map(pr => pr.number));

            // Check if preview directory exists
            if (!fs.existsSync('preview')) {
              console.log('ℹ️ No preview directory found');
              return;
            }

            const previewFiles = fs.readdirSync('preview');
            const prDirs = previewFiles.filter(f =>
              f.startsWith('pr-') &&
              fs.statSync(`preview/${f}`).isDirectory()
            );

            const dirsToRemove = [];
            for (const dir of prDirs) {
              const prNumber = parseInt(dir.replace('pr-', ''));
              if (!isNaN(prNumber) && !openPRNumbers.has(prNumber)) {
                dirsToRemove.push(`preview/${dir}`);
              }
            }

            if (dirsToRemove.length > 0) {
              const msg =
                `Found ${dirsToRemove.length} closed PR preview(s): ` +
                `${dirsToRemove.join(', ')}`;
              console.log(msg);

              await exec.exec('git',
                ['config', 'user.name', 'github-actions[bot]']);
              await exec.exec('git',
                ['config', 'user.email',
                 'github-actions[bot]@users.noreply.github.com']);

              for (const dir of dirsToRemove) {
                await exec.exec('git', ['rm', '-rf', dir]);
              }

              const commitMsg =
                `Cleanup previews for closed PRs: ` +
                `${dirsToRemove.join(', ')}`;
              await exec.exec('git', ['commit', '-m', commitMsg]);
              await exec.exec('git', ['push']);

              console.log('✅ Cleanup completed');
            } else {
              console.log('ℹ️ No closed PR previews to clean up');
            }
