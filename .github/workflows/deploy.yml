name: Deploy ROQ site to GitHub Pages

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build ROQ site
        run: ./mvnw package quarkus:run
        env:
          QUARKUS_ROQ_GENERATOR_BATCH: true
          QUARKUS_HTTP_ROOT_PATH: /pejsam-website/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: target/roq

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  cleanup-closed-prs:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Cleanup closed PR preview folders
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const exec = require('@actions/exec');

            const { data: openPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const openPRNumbers = new Set(openPRs.map(pr => pr.number));

            // Check if preview directory exists
            if (!fs.existsSync('preview')) {
              console.log('ℹ️ No preview directory found');
              return;
            }

            const previewFiles = fs.readdirSync('preview');
            const prDirs = previewFiles.filter(f =>
              f.startsWith('pr-') &&
              fs.statSync(`preview/${f}`).isDirectory()
            );

            const dirsToRemove = [];
            for (const dir of prDirs) {
              const prNumber = parseInt(dir.replace('pr-', ''));
              if (!isNaN(prNumber) && !openPRNumbers.has(prNumber)) {
                dirsToRemove.push(`preview/${dir}`);
              }
            }

            if (dirsToRemove.length > 0) {
              const msg =
                `Found ${dirsToRemove.length} closed PR preview(s): ` +
                `${dirsToRemove.join(', ')}`;
              console.log(msg);

              await exec.exec('git',
                ['config', 'user.name', 'github-actions[bot]']);
              await exec.exec('git',
                ['config', 'user.email',
                 'github-actions[bot]@users.noreply.github.com']);

              for (const dir of dirsToRemove) {
                await exec.exec('git', ['rm', '-rf', dir]);
              }

              const commitMsg =
                `Cleanup previews for closed PRs: ` +
                `${dirsToRemove.join(', ')}`;
              await exec.exec('git', ['commit', '-m', commitMsg]);
              await exec.exec('git', ['push']);

              console.log('✅ Cleanup completed');
            } else {
              console.log('ℹ️ No closed PR previews to clean up');
            }
